stages:
  - quality
  - test
  - coverage
  - security
  - sync

default:
  timeout: 10m
  retry:
    max: 1
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
      - scheduler_failure

variables:
  CI_IMAGE: $CI_REGISTRY_IMAGE/ci:latest

lint:
  stage: quality
  image: $CI_IMAGE
  before_script:
    - pip install --no-deps -e .
  script:
    - ruff check src/ tests/
    - ruff format --check src/ tests/

test:all:
  stage: test
  image: $CI_IMAGE
  before_script:
    - pip install --no-deps -e .
  script:
    - coverage run -m pytest tests/ -v --tb=short
  artifacts:
    paths:
      - .coverage
      - .coverage.*
    expire_in: 1 hour

test:typecheck:
  stage: test
  image: $CI_IMAGE
  before_script:
    - pip install --no-deps -e .
  script:
    - mypy src/timeblock --check-untyped-defs
  timeout: 5m

coverage:report:
  stage: coverage
  image: $CI_IMAGE
  before_script:
    - pip install --no-deps -e .
  needs:
    - job: test:all
      artifacts: true
  script:
    - ls -la .coverage* || echo "No coverage files found"
    - coverage report --fail-under=85
    - coverage xml -o coverage.xml
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml

security:bandit:
  stage: security
  image: $CI_IMAGE
  needs: []
  before_script: []
  script:
    - bandit -r src/timeblock -f json -o bandit-report.json || true
    - bandit -r src/timeblock -ll
  artifacts:
    paths:
      - bandit-report.json
    when: always

security:deps:
  stage: security
  image: $CI_IMAGE
  needs: []
  before_script: []
  script:
    - pip-audit --format json --output pip-audit-report.json
    - pip-audit
  timeout: 5m
  artifacts:
    paths:
      - pip-audit-report.json
    when: always

sync:github:
  stage: sync
  before_script: []
  script:
    - git remote add github https://x-access-token:${GITHUB_TOKEN}@github.com/fabiodelllima/atomvs-timeblock-terminal.git
    - git push github HEAD:${CI_COMMIT_REF_NAME} --force
    - git push github --tags --force
  rules:
    - if: $CI_COMMIT_TAG
      when: on_success
    - if: $CI_COMMIT_BRANCH
      when: on_success
